# æ–°å¹²çº¿é—ªä¿®å¹³å° - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1.æ¶æ„è®¾è®¡

```mermaid
  graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[React å‰ç«¯åº”ç”¨]
    B --> C[Express.js åç«¯æœåŠ¡]
    C --> D[Supabase æ•°æ®åº“]
    C --> E[Supabase Auth è®¤è¯æœåŠ¡]
    C --> F[Supabase Storage æ–‡ä»¶å­˜å‚¨]

    subgraph "å‰ç«¯å±‚ Frontend Layer"
        B["React 18 + TypeScript<br/>Ant Design + Tailwind CSS<br/>Zustand + React Router"]
    end

    subgraph "åç«¯å±‚ Backend Layer"
        C["Express.js 5.1 + TypeScript<br/>JWT + bcryptjs<br/>CORS + Helmet"]
    end

    subgraph "æ•°æ®æœåŠ¡å±‚ Data Service Layer"
        D["Supabase PostgreSQL<br/>è¡Œçº§å®‰å…¨ç­–ç•¥ RLS"]
        E["Supabase Auth<br/>ç”¨æˆ·è®¤è¯ç®¡ç†"]
        F["Supabase Storage<br/>æ–‡ä»¶ä¸Šä¼ å­˜å‚¨"]
    end

    subgraph "å¤–éƒ¨æœåŠ¡ External Services"
        G["æ”¯ä»˜æœåŠ¡ Payment API"]
        H["çŸ­ä¿¡æœåŠ¡ SMS API"]
    end

    C --> G
    C --> H
```

## 2. Technology Description

### å‰ç«¯æŠ€æœ¯æ ˆ
- **React 18.3.1**: ç°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢æ¡†æ¶ï¼Œæ”¯æŒå¹¶å‘ç‰¹æ€§å’Œè‡ªåŠ¨æ‰¹å¤„ç†
- **TypeScript 5.8.3**: ç±»å‹å®‰å…¨çš„JavaScriptè¶…é›†ï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒ
- **Ant Design 5.26.7**: ä¼ä¸šçº§UIè®¾è®¡è¯­è¨€å’Œç»„ä»¶åº“
- **Tailwind CSS 4.1.11**: å®ç”¨ä¼˜å…ˆçš„CSSæ¡†æ¶ï¼Œå¿«é€Ÿæ„å»ºè‡ªå®šä¹‰è®¾è®¡
- **React Router DOM 7.8.0**: å£°æ˜å¼è·¯ç”±ç®¡ç†ï¼Œæ”¯æŒåµŒå¥—è·¯ç”±å’Œä»£ç åˆ†å‰²
- **Zustand 5.0.7**: è½»é‡çº§çŠ¶æ€ç®¡ç†åº“ï¼Œç®€å•æ˜“ç”¨
- **Axios 1.11.0**: åŸºäºPromiseçš„HTTPå®¢æˆ·ç«¯
- **Vite 7.1.0**: å¿«é€Ÿçš„æ„å»ºå·¥å…·å’Œå¼€å‘æœåŠ¡å™¨

#### å½“å‰å®ç°çŠ¶æ€
- âœ… **ç”¨æˆ·è®¤è¯æµç¨‹**: å®Œæ•´çš„ç™»å½•ã€æ³¨å†Œã€JWTè®¤è¯æœºåˆ¶
- âœ… **è·¯ç”±ä¿æŠ¤**: åŸºäºè§’è‰²çš„è·¯ç”±è®¿é—®æ§åˆ¶
- âœ… **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨Zustandç®¡ç†ç”¨æˆ·ã€è®¢å•ã€æœåŠ¡ç­‰çŠ¶æ€
- âœ… **å“åº”å¼è®¾è®¡**: æ”¯æŒæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯é€‚é…
- âœ… **ç»„ä»¶åŒ–å¼€å‘**: å¯å¤ç”¨çš„ä¸šåŠ¡ç»„ä»¶å’Œé€šç”¨ç»„ä»¶
- ğŸŸ¡ **é”™è¯¯å¤„ç†**: åŸºç¡€é”™è¯¯è¾¹ç•Œï¼Œå¾…å®Œå–„å…¨å±€é”™è¯¯å¤„ç†
- ğŸŸ¡ **æ€§èƒ½ä¼˜åŒ–**: åŸºç¡€ä»£ç åˆ†å‰²ï¼Œå¾…æ·»åŠ æ›´å¤šä¼˜åŒ–ç­–ç•¥

### åç«¯æŠ€æœ¯æ ˆ
- **Express.js 5.1.0**: å¿«é€Ÿã€æç®€çš„Node.js Webåº”ç”¨æ¡†æ¶
- **TypeScript 5.9.2**: æœåŠ¡ç«¯ç±»å‹å®‰å…¨å¼€å‘
- **Supabase 2.54.0**: å¼€æºçš„Firebaseæ›¿ä»£æ–¹æ¡ˆï¼Œæä¾›æ•°æ®åº“ã€è®¤è¯ã€å­˜å‚¨æœåŠ¡
- **JWT (jsonwebtoken 9.0.2)**: JSON Web Tokenç”¨äºç”¨æˆ·è®¤è¯
- **bcryptjs 3.0.2**: å¯†ç å“ˆå¸ŒåŠ å¯†åº“
- **CORS 2.8.5**: è·¨åŸŸèµ„æºå…±äº«ä¸­é—´ä»¶
- **Helmet 8.1.0**: å®‰å…¨ä¸­é—´ä»¶ï¼Œè®¾ç½®å„ç§HTTPå¤´
- **Morgan 1.10.1**: HTTPè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- **Multer 2.0.2**: æ–‡ä»¶ä¸Šä¼ å¤„ç†ä¸­é—´ä»¶

#### å½“å‰å®ç°çŠ¶æ€
- âœ… **RESTful API**: å®Œæ•´çš„ç”¨æˆ·ã€è®¢å•ã€æœåŠ¡ç®¡ç†API
- âœ… **èº«ä»½è®¤è¯**: JWT tokenè®¤è¯å’Œè§’è‰²æƒé™æ§åˆ¶
- âœ… **æ•°æ®éªŒè¯**: è¯·æ±‚å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… **å®‰å…¨é˜²æŠ¤**: CORSã€Helmetå®‰å…¨å¤´è®¾ç½®
- âœ… **æ—¥å¿—è®°å½•**: HTTPè¯·æ±‚æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
- ğŸŸ¡ **æ–‡ä»¶ä¸Šä¼ **: åŸºç¡€Multeré…ç½®ï¼Œå¾…å®Œå–„å›¾ç‰‡å¤„ç†
- ğŸŸ¡ **ç¼“å­˜æœºåˆ¶**: å¾…å®ç°Redisç¼“å­˜
- ğŸ”´ **æ”¯ä»˜é›†æˆ**: å¾…å®ç°ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£

### æ•°æ®åº“å’ŒæœåŠ¡
- **PostgreSQL**: é€šè¿‡Supabaseæä¾›çš„å…³ç³»å‹æ•°æ®åº“
- **Supabase Auth**: ç”¨æˆ·è®¤è¯å’ŒæˆæƒæœåŠ¡
- **Supabase Storage**: æ–‡ä»¶ä¸Šä¼ å’Œå­˜å‚¨æœåŠ¡
- **è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)**: æ•°æ®åº“çº§åˆ«çš„å®‰å…¨æ§åˆ¶
- **Docker + Nginx**: å®¹å™¨åŒ–éƒ¨ç½²å’Œåå‘ä»£ç†

## 3.è·¯ç”±å®šä¹‰

### å‰ç«¯è·¯ç”± (React Router)

| è·¯ç”± | é¡µé¢ç»„ä»¶ | ç”¨é€” | æƒé™è¦æ±‚ |
|------|----------|------|----------|
| `/` | Home | é¦–é¡µï¼Œå±•ç¤ºæœåŠ¡åˆ—è¡¨å’Œå¹³å°ä»‹ç» | å…¬å¼€è®¿é—® |
| `/login` | Login | ç”¨æˆ·ç™»å½•é¡µé¢ | æœªç™»å½•ç”¨æˆ· |
| `/register` | Register | ç”¨æˆ·æ³¨å†Œé¡µé¢ | æœªç™»å½•ç”¨æˆ· |
| `/repair-request` | RepairRequest | æŠ¥ä¿®è¯·æ±‚é¡µé¢ï¼Œç”¨æˆ·æäº¤ç»´ä¿®éœ€æ±‚ | éœ€è¦ç™»å½• |
| `/profile` | Profile | ç”¨æˆ·ä¸ªäººä¸­å¿ƒï¼ŒæŸ¥çœ‹å’Œç¼–è¾‘ä¸ªäººä¿¡æ¯ | éœ€è¦ç™»å½• |
| `/orders` | Orders | è®¢å•ç®¡ç†é¡µé¢ï¼ŒæŸ¥çœ‹è®¢å•å†å²å’ŒçŠ¶æ€ | éœ€è¦ç™»å½• |
| `/order/:id` | OrderDetail | è®¢å•è¯¦æƒ…é¡µé¢ï¼ŒæŸ¥çœ‹å…·ä½“è®¢å•ä¿¡æ¯ | éœ€è¦ç™»å½• |
| `/technician` | TechnicianDashboard | æŠ€å¸ˆå·¥ä½œå°ï¼Œç®¡ç†åˆ†é…çš„è®¢å• | æŠ€å¸ˆæƒé™ |
| `/technician/orders` | TechnicianOrders | æŠ€å¸ˆè®¢å•åˆ—è¡¨ | æŠ€å¸ˆæƒé™ |
| `/admin` | AdminDashboard | ç®¡ç†å‘˜åå°é¦–é¡µï¼Œæ•°æ®æ¦‚è§ˆ | ç®¡ç†å‘˜æƒé™ |
| `/admin/users` | AdminUsers | ç”¨æˆ·ç®¡ç†é¡µé¢ | ç®¡ç†å‘˜æƒé™ |
| `/admin/orders` | AdminOrders | è®¢å•ç®¡ç†é¡µé¢ | ç®¡ç†å‘˜æƒé™ |
| `/admin/services` | AdminServices | æœåŠ¡ç®¡ç†é¡µé¢ | ç®¡ç†å‘˜æƒé™ |
| `/admin/technicians` | AdminTechnicians | æŠ€å¸ˆç®¡ç†é¡µé¢ | ç®¡ç†å‘˜æƒé™ |
| `/finance` | FinanceDashboard | è´¢åŠ¡ç®¡ç†é¡µé¢ | è´¢åŠ¡æƒé™ |
| `*` | NotFound | 404é”™è¯¯é¡µé¢ | å…¬å¼€è®¿é—® |

## 4.APIå®šä¹‰

### 4.1 è®¤è¯ç›¸å…³ API

**ç”¨æˆ·ç™»å½•**
```
POST /api/auth/login
```

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| email | string | true | ç”¨æˆ·é‚®ç®± |
| password | string | true | ç”¨æˆ·å¯†ç  |

Response:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "name": "ç”¨æˆ·å§“å",
      "role": "user"
    }
  }
}
```

**ç”¨æˆ·æ³¨å†Œ**
```
POST /api/auth/register
```

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| email | string | true | ç”¨æˆ·é‚®ç®± |
| password | string | true | ç”¨æˆ·å¯†ç  |
| name | string | true | ç”¨æˆ·å§“å |
| phone | string | false | æ‰‹æœºå·ç  |

**ç”¨æˆ·ç™»å‡º**
```
POST /api/auth/logout
```

**è·å–ç”¨æˆ·ä¿¡æ¯**
```
GET /api/auth/me
```
Headers: `Authorization: Bearer <token>`

### 4.2 è®¢å•ç®¡ç† API

**åˆ›å»ºè®¢å•**
```
POST /api/orders
```
Headers: `Authorization: Bearer <token>`

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| service_id | string | true | æœåŠ¡ç±»å‹ID |
| device_model | string | false | è®¾å¤‡å‹å· |
| description | string | true | æ•…éšœæè¿° |
| images | array | false | æ•…éšœå›¾ç‰‡URLæ•°ç»„ |
| urgency | string | false | ç´§æ€¥ç¨‹åº¦ (normal/urgent/emergency) |
| address | string | true | ç»´ä¿®åœ°å€ |
| contact_phone | string | true | è”ç³»ç”µè¯ |

Response:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "order_no": "XGX202412001",
    "status": "pending",
    "created_at": "2024-12-01T10:00:00Z"
  }
}
```

**è·å–è®¢å•åˆ—è¡¨**
```
GET /api/orders
```
Headers: `Authorization: Bearer <token>`

Query Parameters:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| status | string | false | è®¢å•çŠ¶æ€ç­›é€‰ |
| page | number | false | é¡µç ï¼Œé»˜è®¤1 |
| limit | number | false | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10 |

**è·å–è®¢å•è¯¦æƒ…**
```
GET /api/orders/:id
```
Headers: `Authorization: Bearer <token>`

**æ›´æ–°è®¢å•çŠ¶æ€**
```
PUT /api/orders/:id/status
```
Headers: `Authorization: Bearer <token>`

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| status | string | true | æ–°çŠ¶æ€ |
| note | string | false | çŠ¶æ€å˜æ›´å¤‡æ³¨ |

### 4.3 æœåŠ¡ç®¡ç† API

**è·å–æœåŠ¡åˆ—è¡¨**
```
GET /api/services
```

Query Parameters:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| category | string | false | æœåŠ¡åˆ†ç±»ç­›é€‰ |
| active | boolean | false | æ˜¯å¦å¯ç”¨ |

**åˆ›å»ºæœåŠ¡**
```
POST /api/services
```
Headers: `Authorization: Bearer <token>` (ç®¡ç†å‘˜æƒé™)

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| name | string | true | æœåŠ¡åç§° |
| description | string | true | æœåŠ¡æè¿° |
| base_price | number | true | åŸºç¡€ä»·æ ¼ |
| category | string | true | æœåŠ¡åˆ†ç±» |
| options | object | false | æœåŠ¡é€‰é¡¹é…ç½® |

### 4.4 ç”¨æˆ·ç®¡ç† API

**è·å–ç”¨æˆ·åˆ—è¡¨**
```
GET /api/users
```
Headers: `Authorization: Bearer <token>` (ç®¡ç†å‘˜æƒé™)

Query Parameters:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| role | string | false | ç”¨æˆ·è§’è‰²ç­›é€‰ |
| page | number | false | é¡µç  |
| limit | number | false | æ¯é¡µæ•°é‡ |

**æ›´æ–°ç”¨æˆ·è§’è‰²**
```
PUT /api/users/:id/role
```
Headers: `Authorization: Bearer <token>` (ç®¡ç†å‘˜æƒé™)

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| role | string | true | æ–°è§’è‰² (user/technician/admin/finance) |

### 4.5 æ”¯ä»˜ç›¸å…³ API

**åˆ›å»ºæ”¯ä»˜**
```
POST /api/payments
```
Headers: `Authorization: Bearer <token>`

Request:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| order_id | string | true | è®¢å•ID |
| amount | number | true | æ”¯ä»˜é‡‘é¢ |
| method | string | true | æ”¯ä»˜æ–¹å¼ (alipay/wechat/bank) |

Response:
```json
{
  "success": true,
  "data": {
    "payment_id": "uuid",
    "payment_url": "https://payment.example.com/pay/xxx",
    "qr_code": "data:image/png;base64,xxx"
  }
}
```

## 5.æœåŠ¡å™¨æ¶æ„å›¾

```mermaid
graph TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[Nginx åå‘ä»£ç†]
    B --> C[Express.js åº”ç”¨]
    C --> D[è®¤è¯ä¸­é—´ä»¶ Auth Middleware]
    D --> E[è·¯ç”±å±‚ Router Layer]
    E --> F[æ§åˆ¶å™¨å±‚ Controller Layer]
    F --> G[æœåŠ¡å±‚ Service Layer]
    G --> H[æ•°æ®è®¿é—®å±‚ Repository Layer]
    H --> I[(Supabase PostgreSQL)]
    
    G --> J[Supabase Auth]
    G --> K[Supabase Storage]
    G --> L[å¤–éƒ¨æ”¯ä»˜API]
    G --> M[çŸ­ä¿¡æœåŠ¡API]
    
    subgraph "Express.js åº”ç”¨æœåŠ¡å™¨"
        C
        D
        E
        F
        G
        H
    end
    
    subgraph "Supabase æœåŠ¡"
        I
        J
        K
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        L
        M
    end
    
    subgraph "ä¸­é—´ä»¶å±‚"
        N[CORS ä¸­é—´ä»¶]
        O[Helmet å®‰å…¨ä¸­é—´ä»¶]
        P[Morgan æ—¥å¿—ä¸­é—´ä»¶]
        Q[Multer æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶]
    end
    
    C --> N
    C --> O
    C --> P
    C --> Q
```

## 6.æ•°æ®æ¨¡å‹

### 6.1 æ•°æ®æ¨¡å‹å®šä¹‰

```mermaid
erDiagram
    USERS ||--o{ ORDERS : creates
    USERS ||--o{ REVIEWS : writes
    USERS ||--o{ ORDER_STATUS_HISTORY : operates
    ORDERS ||--|| PAYMENTS : has
    ORDERS ||--o{ ORDER_STATUS_HISTORY : tracks
    ORDERS ||--o{ REVIEWS : receives
    SERVICES ||--o{ ORDERS : includes
    
    USERS {
        uuid id PK
        string email UK
        string password_hash
        string name
        string phone
        string role
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    ORDERS {
        uuid id PK
        string order_no UK
        uuid user_id FK
        uuid service_id FK
        string device_model
        text description
        json images
        string urgency
        string status
        decimal quoted_price
        decimal final_price
        uuid assigned_to FK
        string address
        string contact_phone
        timestamp created_at
        timestamp updated_at
    }
    
    SERVICES {
        uuid id PK
        string name
        text description
        decimal base_price
        string category
        json options
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    PAYMENTS {
        uuid id PK
        uuid order_id FK
        decimal amount
        string method
        string status
        string transaction_id
        timestamp paid_at
        timestamp created_at
        timestamp updated_at
    }
    
    REVIEWS {
        uuid id PK
        uuid order_id FK
        uuid user_id FK
        integer rating
        text comment
        json images
        timestamp created_at
    }
    
    ORDER_STATUS_HISTORY {
        uuid id PK
        uuid order_id FK
        uuid operator_id FK
        string old_status
        string new_status
        text note
        timestamp created_at
    }
```

### 6.2 æ•°æ®å®šä¹‰è¯­è¨€ (DDL)

**ç”¨æˆ·è¡¨ (users)**
```sql
-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'technician', 'admin', 'finance')),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_phone ON users(phone);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- æƒé™è®¾ç½®
GRANT SELECT ON users TO anon;
GRANT ALL PRIVILEGES ON users TO authenticated;

-- åˆå§‹åŒ–ç®¡ç†å‘˜ç”¨æˆ·
INSERT INTO users (email, password_hash, name, role) VALUES
('admin@xgx.com', '$2b$10$example_hash', 'ç³»ç»Ÿç®¡ç†å‘˜', 'admin'),
('finance@xgx.com', '$2b$10$example_hash', 'è´¢åŠ¡ç®¡ç†å‘˜', 'finance');
```

**æœåŠ¡é¡¹ç›®è¡¨ (services)**
```sql
-- åˆ›å»ºæœåŠ¡é¡¹ç›®è¡¨
CREATE TABLE services (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    base_price DECIMAL(10,2) DEFAULT 0,
    category VARCHAR(50) DEFAULT 'other',
    options JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_services_active ON services(is_active);
CREATE INDEX idx_services_category ON services(category);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER update_services_updated_at BEFORE UPDATE ON services
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE services ENABLE ROW LEVEL SECURITY;

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO services (name, description, base_price, category, options) VALUES
('å±å¹•ç»´ä¿®', 'æ‰‹æœº/å¹³æ¿å±å¹•æ›´æ¢ç»´ä¿®', 150.00, 'screen', '{"devices": ["æ‰‹æœº", "å¹³æ¿"], "warranty": "3ä¸ªæœˆ"}'),
('ç”µæ± æ›´æ¢', 'è®¾å¤‡ç”µæ± æ›´æ¢æœåŠ¡', 80.00, 'battery', '{"devices": ["æ‰‹æœº", "ç¬”è®°æœ¬"], "warranty": "6ä¸ªæœˆ"}'),
('ç³»ç»Ÿé‡è£…', 'ç”µè„‘ç³»ç»Ÿé‡æ–°å®‰è£…ï¼ŒåŒ…å«é©±åŠ¨å®‰è£…', 50.00, 'system', '{"includes": ["ç³»ç»Ÿå®‰è£…", "é©±åŠ¨å®‰è£…", "åŸºç¡€è½¯ä»¶"]}'),
('æ•°æ®æ¢å¤', 'ç¡¬ç›˜/å­˜å‚¨è®¾å¤‡æ•°æ®æ¢å¤', 200.00, 'data', '{"success_rate": "85%", "time": "1-3å¤©"}'),
('æ¸…ç°æœåŠ¡', 'ç”µè„‘å†…éƒ¨æ¸…ç°ï¼Œæå‡æ•£çƒ­æ•ˆæœ', 30.00, 'maintenance', '{"liquid_metal": {"price": 20, "description": "æ¶²é‡‘å¯¼çƒ­"}}'),
('è½¯ä»¶å®‰è£…', 'å¸¸ç”¨è½¯ä»¶å®‰è£…é…ç½®', 20.00, 'software', '{}'),
('è¿›æ°´ç»´ä¿®', 'è®¾å¤‡è¿›æ°´å¤„ç†å’Œç»´ä¿®', 100.00, 'water_damage', '{"success_rate": "70%", "time": "2-5å¤©"});

-- æƒé™è®¾ç½®
GRANT SELECT ON services TO anon;
GRANT ALL PRIVILEGES ON services TO authenticated;
```

**è®¢å•è¡¨ (orders)**
```sql
-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_no VARCHAR(50) UNIQUE NOT NULL,
    user_id UUID NOT NULL REFERENCES users(id),
    service_id UUID REFERENCES services(id),
    device_model VARCHAR(100),
    description TEXT NOT NULL,
    images JSONB DEFAULT '[]',
    urgency VARCHAR(20) DEFAULT 'normal' CHECK (urgency IN ('urgent', 'normal', 'emergency')),
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'quoted', 'paid', 'assigned', 'processing', 'completed', 'cancelled')),
    quoted_price DECIMAL(10,2),
    final_price DECIMAL(10,2),
    assigned_to UUID REFERENCES users(id),
    address TEXT NOT NULL,
    contact_phone VARCHAR(20) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_service_id ON orders(service_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_assigned_to ON orders(assigned_to);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_order_no ON orders(order_no);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºè®¢å•å·ç”Ÿæˆå‡½æ•°
CREATE OR REPLACE FUNCTION generate_order_no()
RETURNS TEXT AS $$
DECLARE
    new_order_no TEXT;
BEGIN
    new_order_no := 'XGX' || TO_CHAR(NOW(), 'YYYYMMDD') || LPAD(NEXTVAL('order_no_seq')::TEXT, 3, '0');
    RETURN new_order_no;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºåºåˆ—
CREATE SEQUENCE IF NOT EXISTS order_no_seq START 1;

-- æƒé™è®¾ç½®
GRANT SELECT ON orders TO anon;
GRANT ALL PRIVILEGES ON orders TO authenticated;
```

**æ”¯ä»˜è¡¨ (payments)**
```sql
-- åˆ›å»ºæ”¯ä»˜è¡¨
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL UNIQUE,
    amount DECIMAL(10,2) NOT NULL,
    method VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
    transaction_id VARCHAR(100),
    paid_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_status ON payments(status);

-- æƒé™è®¾ç½®
GRANT SELECT ON payments TO anon;
GRANT ALL PRIVILEGES ON payments TO authenticated;
```

**è¯„ä»·è¡¨ (reviews)**
```sql
-- åˆ›å»ºè¯„ä»·è¡¨
CREATE TABLE reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL UNIQUE,
    user_id UUID NOT NULL,
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    images JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_reviews_order_id ON reviews(order_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);

-- æƒé™è®¾ç½®
GRANT SELECT ON reviews TO anon;
GRANT ALL PRIVILEGES ON reviews TO authenticated;
```

**è®¢å•æ—¥å¿—è¡¨ (order_logs)**
```sql
-- åˆ›å»ºè®¢å•æ—¥å¿—è¡¨
CREATE TABLE order_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL,
    operator_id UUID NOT NULL,
    action VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_order_logs_order_id ON order_logs(order_id);
CREATE INDEX idx_order_logs_created_at ON order_logs(created_at DESC);

-- æƒé™è®¾ç½®
GRANT SELECT ON order_logs TO anon;
GRANT ALL PRIVILEGES ON order_logs TO authenticated;
```