# 新干线闪修平台开发指南

## 目录

1. [项目架构](#项目架构)
2. [开发环境搭建](#开发环境搭建)
3. [前端开发指南](#前端开发指南)
4. [后端开发指南](#后端开发指南)
5. [数据库设计](#数据库设计)
6. [API设计规范](#api设计规范)
7. [安全考虑](#安全考虑)
8. [性能优化](#性能优化)
9. [测试策略](#测试策略)
10. [部署指南](#部署指南)

## 项目架构

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │────│  后端 (Express) │────│ 数据库 (Supabase)│
│                 │    │                 │    │                 │
│ - React 18      │    │ - Node.js       │    │ - PostgreSQL    │
│ - TypeScript    │    │ - Express       │    │ - RLS           │
│ - Ant Design    │    │ - TypeScript    │    │ - Real-time     │
│ - Zustand       │    │ - JWT Auth      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术选型理由

- **React 18**: 现代化的前端框架，支持并发特性
- **TypeScript**: 提供类型安全，减少运行时错误
- **Ant Design**: 企业级UI组件库，开发效率高
- **Zustand**: 轻量级状态管理，简单易用
- **Express.js**: 成熟的Node.js Web框架
- **Supabase**: 提供数据库、认证、实时订阅等服务

## 开发环境搭建

### 必需软件

1. **Node.js** (>= 18.0.0)
   ```bash
   # 检查版本
   node --version
   npm --version
   ```

2. **Git**
   ```bash
   git --version
   ```

3. **VS Code** (推荐)
   - 安装推荐扩展：
     - TypeScript and JavaScript Language Features
     - ES7+ React/Redux/React-Native snippets
     - Prettier - Code formatter
     - ESLint

### 项目初始化

```bash
# 克隆项目
git clone <repository-url>
cd XGX_Flash_Fix

# 安装依赖
cd frontend && npm install
cd ../backend && npm install

# 配置环境变量
cp backend/.env.example backend/.env
cp frontend/.env.example frontend/.env

# 启动开发服务器
npm run dev:all  # 同时启动前后端
```

### 开发服务器启动

```bash
# 方式1: 分别启动（推荐用于开发调试）
# 终端1 - 启动后端
cd backend
npm run dev

# 终端2 - 启动前端
cd frontend
npm run dev

# 方式2: 同时启动
npm run dev
```

**访问地址:**
- 前端应用: http://localhost:5174
- 后端API: http://localhost:3001
- API文档: http://localhost:3001/api-docs (如果配置了Swagger)

## 前端开发指南

### 项目结构

```
frontend/
├── src/
│   ├── components/          # 可复用组件
│   │   ├── common/         # 通用组件
│   │   ├── forms/          # 表单组件
│   │   └── layout/         # 布局组件
│   ├── pages/              # 页面组件
│   │   ├── auth/           # 认证相关页面
│   │   ├── orders/         # 订单相关页面
│   │   ├── admin/          # 管理后台页面
│   │   └── technician/     # 技师工作台页面
│   ├── store/              # 状态管理
│   │   ├── authStore.ts    # 认证状态
│   │   ├── orderStore.ts   # 订单状态
│   │   ├── userStore.ts    # 用户状态
│   │   └── serviceStore.ts # 服务状态
│   ├── router/             # 路由配置
│   │   └── index.tsx       # 路由定义
│   ├── utils/              # 工具函数
│   │   ├── api.ts          # API请求封装
│   │   └── constants.ts    # 常量定义
│   └── types/              # TypeScript类型定义
       └── index.ts
```

### 开发规范

#### 组件开发规范
1. **组件命名**: 使用PascalCase，如`OrderManagement`
2. **文件命名**: 与组件名保持一致，如`OrderManagement.tsx`
3. **Props类型定义**: 每个组件都应定义Props接口
4. **导入顺序**: React相关 → 第三方库 → 本地组件 → 工具函数 → 类型定义

```typescript
// 示例组件结构
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Button, Table } from 'antd';
import { useOrderStore } from '../store/orderStore';
import { Order } from '../types';

interface OrderManagementProps {
  // props定义
}

const OrderManagement: React.FC<OrderManagementProps> = () => {
  const navigate = useNavigate();
  // 组件逻辑
  return (
    // JSX
  );
};

export default OrderManagement;
```

#### 状态管理规范
使用Zustand进行状态管理，每个store应包含：
- 状态数据
- 加载状态
- 错误状态
- 异步操作方法

```typescript
// 示例store结构
interface OrderState {
  orders: Order[];
  total: number;
  isLoading: boolean;
  error: string | null;
  fetchOrders: () => Promise<void>;
  createOrder: (order: CreateOrderRequest) => Promise<void>;
}
```
## 常见问题和故障排除

### 前端开发问题

#### 1. useNavigate is not defined 错误
**问题描述**: 组件中使用useNavigate但未导入
**解决方案**: 
```typescript
import { useNavigate } from 'react-router-dom';
```

#### 2. 数据字段映射错误
**问题描述**: 前端显示的数据与后端返回的字段名不匹配
**解决方案**: 检查并统一前后端字段命名
```typescript
// 错误示例
dataIndex: 'orderNo'  // 前端使用
// 后端返回: order_number

// 正确示例
dataIndex: 'order_number'  // 与后端保持一致
```

#### 3. 嵌套对象字段访问
**问题描述**: 需要访问关联表的数据
**解决方案**: 使用数组形式的dataIndex
```typescript
// 访问用户名称
dataIndex: ['users', 'name']
// 访问服务名称
dataIndex: ['services', 'name']
```

### 后端开发问题

#### 1. HTTP方法不匹配
**问题描述**: 前端请求方法与后端路由定义不一致
**解决方案**: 确保前后端HTTP方法一致
```typescript
// 后端路由
router.put('/:id/assign', assignTechnician);

// 前端请求
api.put(`/orders/${orderId}/assign`, { technicianId });
```

#### 2. 数据库字段命名规范
**问题描述**: 数据库使用下划线命名，前端使用驼峰命名
**解决方案**: 统一使用数据库的下划线命名
```sql
-- 数据库字段
order_number, created_at, final_price
```

### 开发环境问题

#### 1. 端口冲突
**问题描述**: 开发服务器端口被占用
**解决方案**: 
```bash
# 查看端口占用
netstat -ano | findstr :5174
# 或修改vite.config.ts中的端口配置
```

#### 2. 热更新不生效
**问题描述**: 代码修改后页面不自动刷新
**解决方案**: 
1. 检查文件保存是否成功
2. 重启开发服务器
3. 清除浏览器缓存

### 调试技巧

#### 1. 网络请求调试
```typescript
// 在axios拦截器中添加日志
api.interceptors.request.use(config => {
  console.log('Request:', config);
  return config;
});

api.interceptors.response.use(
  response => {
    console.log('Response:', response);
    return response;
  },
  error => {
    console.error('Error:', error);
    return Promise.reject(error);
  }
);
```

#### 2. 状态管理调试
```typescript
// 在store中添加日志
const useOrderStore = create<OrderState>((set, get) => ({
  // ... 其他状态
  fetchOrders: async () => {
    console.log('Fetching orders...');
    try {
      const response = await api.get('/orders');
      console.log('Orders fetched:', response.data);
      set({ orders: response.data.data });
    } catch (error) {
      console.error('Fetch orders error:', error);
    }
  }
}));
```

### 性能优化建议

#### 1. 组件优化
- 使用React.memo包装纯组件
- 合理使用useCallback和useMemo
- 避免在render中创建新对象

#### 2. 网络请求优化
- 实现请求缓存
- 使用防抖和节流
- 合并相似的API请求

#### 3. 打包优化
- 启用代码分割
- 优化图片资源
- 移除未使用的依赖

### 代码质量保证

#### 1. TypeScript严格模式
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "noImplicitReturns": true
  }
}
```

#### 2. ESLint规则
```json
// .eslintrc.js
module.exports = {
  rules: {
    '@typescript-eslint/no-unused-vars': 'error',
    'react-hooks/exhaustive-deps': 'warn'
  }
};
```

### 版本更新记录

#### v1.0.1 (2025-01-08) 修复内容
1. 修正订单指派接口HTTP方法不匹配问题
2. 解决订单管理页面useNavigate未导入错误
3. 修复仪表盘数据字段映射问题
4. 统一订单详情页面路由路径
5. 完善前后端数据字段命名一致性
│   │   ├── constants.ts    # 常量定义
│   │   └── helpers.ts      # 辅助函数
│   ├── types/              # 类型定义
│   │   ├── auth.ts         # 认证相关类型
│   │   ├── order.ts        # 订单相关类型
│   │   └── user.ts         # 用户相关类型
│   ├── hooks/              # 自定义Hook
│   └── styles/             # 样式文件
├── public/                 # 静态资源
└── package.json
```

### 组件开发规范

#### 1. 组件命名

```typescript
// ✅ 正确：使用PascalCase
const UserProfile = () => {
  return <div>User Profile</div>;
};

// ❌ 错误：使用camelCase
const userProfile = () => {
  return <div>User Profile</div>;
};
```

#### 2. 组件结构

```typescript
// components/UserCard.tsx
import React from 'react';
import { Card, Avatar, Button } from 'antd';
import { User } from '@/types/user';

interface UserCardProps {
  user: User;
  onEdit?: (user: User) => void;
  className?: string;
}

const UserCard: React.FC<UserCardProps> = ({ 
  user, 
  onEdit, 
  className 
}) => {
  const handleEdit = () => {
    onEdit?.(user);
  };

  return (
    <Card className={className}>
      <Avatar src={user.avatar} size={64} />
      <h3>{user.name}</h3>
      <p>{user.email}</p>
      {onEdit && (
        <Button onClick={handleEdit}>编辑</Button>
      )}
    </Card>
  );
};

export default UserCard;
```

#### 3. 状态管理

```typescript
// store/authStore.ts
import { create } from 'zustand';
import { User } from '@/types/user';
import api from '@/utils/axios';

interface AuthState {
  user: User | null;
  token: string | null;
  isLoading: boolean;
  login: (phone: string, password: string) => Promise<void>;
  logout: () => void;
  updateProfile: (data: Partial<User>) => Promise<void>;
}

export const useAuthStore = create<AuthState>((set, get) => ({
  user: null,
  token: localStorage.getItem('token'),
  isLoading: false,

  login: async (phone: string, password: string) => {
    set({ isLoading: true });
    try {
      const response = await api.post('/api/v1/auth/login', {
        phone,
        password,
        role: 'user'
      });
      
      const { user, token } = response.data.data;
      localStorage.setItem('token', token);
      set({ user, token, isLoading: false });
    } catch (error) {
      set({ isLoading: false });
      throw error;
    }
  },

  logout: () => {
    localStorage.removeItem('token');
    set({ user: null, token: null });
  },

  updateProfile: async (data: Partial<User>) => {
    const response = await api.put('/api/v1/auth/profile', data);
    set({ user: response.data.data });
  }
}));
```

### 路由配置

```typescript
// App.tsx
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { useAuthStore } from '@/store/authStore';

// 页面组件
import Login from '@/pages/auth/Login';
import Register from '@/pages/auth/Register';
import Dashboard from '@/pages/dashboard/Dashboard';
import Orders from '@/pages/orders/Orders';
import OrderDetail from '@/pages/orders/OrderDetail';

// 路由守卫
const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const { token } = useAuthStore();
  return token ? <>{children}</> : <Navigate to="/login" />;
};

const App = () => {
  return (
    <BrowserRouter>
      <Routes>
        {/* 公开路由 */}
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        
        {/* 受保护的路由 */}
        <Route path="/" element={
          <ProtectedRoute>
            <Dashboard />
          </ProtectedRoute>
        } />
        <Route path="/orders" element={
          <ProtectedRoute>
            <Orders />
          </ProtectedRoute>
        } />
        <Route path="/orders/:id" element={
          <ProtectedRoute>
            <OrderDetail />
          </ProtectedRoute>
        } />
        
        {/* 默认重定向 */}
        <Route path="*" element={<Navigate to="/" />} />
      </Routes>
    </BrowserRouter>
  );
};

export default App;
```

## 后端开发指南

### 项目结构

```
backend/
├── src/
│   ├── controllers/        # 控制器
│   │   ├── authController.ts
│   │   ├── orderController.ts
│   │   └── userController.ts
│   ├── routes/            # 路由定义
│   │   ├── auth.ts
│   │   ├── orders.ts
│   │   ├── users.ts
│   │   └── index.ts
│   ├── middleware/        # 中间件
│   │   ├── auth.ts        # 认证中间件
│   │   ├── validation.ts  # 数据验证
│   │   └── errorHandler.ts
│   ├── utils/            # 工具函数
│   │   ├── supabase.ts   # 数据库连接
│   │   ├── jwt.ts        # JWT工具
│   │   └── bcrypt.ts     # 密码加密
│   ├── types/            # 类型定义
│   └── index.ts          # 应用入口
├── .env                  # 环境变量
└── package.json
```

### API开发规范

#### 1. 控制器结构

```typescript
// controllers/orderController.ts
import { Request, Response } from 'express';
import { supabase } from '@/utils/supabase';
import { AuthRequest } from '@/types/auth';

export const createOrder = async (req: AuthRequest, res: Response) => {
  try {
    const { serviceId, deviceType, deviceModel, description, urgency, contactAddress, contactPhone } = req.body;
    const userId = req.user?.id;

    // 数据验证
    if (!serviceId || !deviceType || !description) {
      return res.status(400).json({
        success: false,
        message: '缺少必要参数'
      });
    }

    // 生成订单号
    const orderNumber = `XGX${Date.now()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;

    // 创建订单
    const { data, error } = await supabase
      .from('orders')
      .insert({
        order_number: orderNumber,
        user_id: userId,
        service_id: serviceId,
        device_type: deviceType,
        device_model: deviceModel,
        description,
        urgency,
        contact_address: contactAddress,
        contact_phone: contactPhone,
        status: 'pending'
      })
      .select()
      .single();

    if (error) {
      throw error;
    }

    res.status(201).json({
      success: true,
      message: '订单创建成功',
      data
    });
  } catch (error) {
    console.error('Create order error:', error);
    res.status(500).json({
      success: false,
      message: '创建订单失败'
    });
  }
};
```

#### 2. 中间件开发

```typescript
// middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import { verifyToken } from '@/utils/jwt';
import { supabase } from '@/utils/supabase';

export interface AuthRequest extends Request {
  user?: {
    id: string;
    role: string;
    phone: string;
  };
}

export const authenticateToken = async (
  req: AuthRequest,
  res: Response,
  next: NextFunction
) => {
  try {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
      return res.status(401).json({
        success: false,
        message: '访问令牌缺失'
      });
    }

    const decoded = verifyToken(token);
    if (!decoded) {
      return res.status(403).json({
        success: false,
        message: '无效的访问令牌'
      });
    }

    // 验证用户是否存在
    const { data: user, error } = await supabase
      .from('users')
      .select('id, role, phone')
      .eq('id', decoded.userId)
      .single();

    if (error || !user) {
      return res.status(403).json({
        success: false,
        message: '用户不存在'
      });
    }

    req.user = user;
    next();
  } catch (error) {
    return res.status(403).json({
      success: false,
      message: '令牌验证失败'
    });
  }
};

// 角色权限检查
export const requireRole = (roles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user || !roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        message: '权限不足'
      });
    }
    next();
  };
};
```

#### 3. 路由定义

```typescript
// routes/orders.ts
import { Router } from 'express';
import {
  createOrder,
  getOrders,
  getOrderById,
  updateOrderStatus,
  assignTechnician,
  getOrderStats
} from '@/controllers/orderController';
import { authenticateToken, requireRole } from '@/middleware/auth';

const router = Router();

// 创建订单 - 所有认证用户
router.post('/', authenticateToken, createOrder);

// 获取订单列表 - 所有认证用户
router.get('/', authenticateToken, getOrders);

// 获取订单详情 - 所有认证用户
router.get('/:id', authenticateToken, getOrderById);

// 更新订单状态 - 技术员和管理员
router.put('/:id/status', 
  authenticateToken, 
  requireRole(['technician', 'admin']), 
  updateOrderStatus
);

// 分配技术员 - 仅管理员
router.put('/:id/assign', 
  authenticateToken, 
  requireRole(['admin']), 
  assignTechnician
);

// 获取订单统计 - 管理员和财务
router.get('/stats', 
  authenticateToken, 
  requireRole(['admin', 'finance']), 
  getOrderStats
);

export default router;
```

## 数据库设计

### 表结构设计

#### 1. 用户表 (users)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20) UNIQUE NOT NULL,
  email VARCHAR(255),
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'technician', 'admin', 'finance', 'service')),
  avatar TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2. 服务表 (services)

```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category VARCHAR(100) NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  estimated_duration INTEGER, -- 预计时长（分钟）
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3. 订单表 (orders)

```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number VARCHAR(50) UNIQUE NOT NULL,
  user_id UUID NOT NULL REFERENCES users(id),
  service_id UUID NOT NULL REFERENCES services(id),
  technician_id UUID REFERENCES users(id),
  device_type VARCHAR(100) NOT NULL,
  device_model VARCHAR(100),
  description TEXT NOT NULL,
  urgency VARCHAR(20) NOT NULL CHECK (urgency IN ('low', 'medium', 'high', 'urgent')),
  status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'accepted', 'confirmed', 'in_progress', 'completed', 'cancelled', 'paid')),
  price DECIMAL(10,2),
  contact_address TEXT,
  contact_phone VARCHAR(20),
  contact_name VARCHAR(100),
  images TEXT[], -- 存储图片URL数组
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### RLS (Row Level Security) 策略

```sql
-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;

-- 用户表策略
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth.uid()::text = id::text);

CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid()::text = id::text);

-- 订单表策略
CREATE POLICY "Users can view own orders" ON orders
  FOR SELECT USING (
    user_id::text = auth.uid()::text OR 
    technician_id::text = auth.uid()::text OR
    EXISTS (
      SELECT 1 FROM users 
      WHERE id::text = auth.uid()::text 
      AND role IN ('admin', 'finance')
    )
  );

CREATE POLICY "Users can create orders" ON orders
  FOR INSERT WITH CHECK (user_id::text = auth.uid()::text);

-- 服务表策略
CREATE POLICY "Anyone can view active services" ON services
  FOR SELECT USING (is_active = true);
```

## API设计规范

### 响应格式

```typescript
// 成功响应
{
  "success": true,
  "message": "操作成功",
  "data": {
    // 响应数据
  }
}

// 错误响应
{
  "success": false,
  "message": "错误信息",
  "error": {
    "code": "ERROR_CODE",
    "details": "详细错误信息"
  }
}

// 分页响应
{
  "success": true,
  "message": "获取成功",
  "data": {
    "items": [],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "totalPages": 10
    }
  }
}
```

### HTTP状态码使用

- `200 OK` - 请求成功
- `201 Created` - 资源创建成功
- `400 Bad Request` - 请求参数错误
- `401 Unauthorized` - 未认证
- `403 Forbidden` - 权限不足
- `404 Not Found` - 资源不存在
- `409 Conflict` - 资源冲突
- `422 Unprocessable Entity` - 数据验证失败
- `500 Internal Server Error` - 服务器内部错误

## 安全考虑

### 1. 认证和授权

- 使用JWT进行身份验证
- 实现基于角色的访问控制(RBAC)
- 定期刷新访问令牌
- 安全存储敏感信息

### 2. 数据验证

```typescript
// 输入验证示例
import Joi from 'joi';

const createOrderSchema = Joi.object({
  serviceId: Joi.string().uuid().required(),
  deviceType: Joi.string().min(1).max(100).required(),
  deviceModel: Joi.string().max(100),
  description: Joi.string().min(10).max(1000).required(),
  urgency: Joi.string().valid('low', 'medium', 'high', 'urgent').required(),
  contactAddress: Joi.string().max(500),
  contactPhone: Joi.string().pattern(/^1[3-9]\d{9}$/)
});

export const validateCreateOrder = (req: Request, res: Response, next: NextFunction) => {
  const { error } = createOrderSchema.validate(req.body);
  if (error) {
    return res.status(400).json({
      success: false,
      message: '数据验证失败',
      error: error.details[0].message
    });
  }
  next();
};
```

### 3. SQL注入防护

- 使用参数化查询
- 避免动态SQL拼接
- 使用ORM或查询构建器

### 4. XSS防护

- 对用户输入进行转义
- 使用Content Security Policy
- 验证和清理HTML内容

## 性能优化

### 1. 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_users_phone ON users(phone);
```

### 2. 前端优化

- 使用React.memo优化组件渲染
- 实现虚拟滚动处理大列表
- 使用懒加载减少初始包大小
- 优化图片加载和缓存

### 3. 后端优化

- 实现API响应缓存
- 使用连接池管理数据库连接
- 实现请求限流
- 优化数据库查询

## 测试策略

### 1. 单元测试

```typescript
// 测试工具函数
import { generateOrderNumber } from '@/utils/helpers';

describe('generateOrderNumber', () => {
  it('should generate unique order number', () => {
    const orderNumber1 = generateOrderNumber();
    const orderNumber2 = generateOrderNumber();
    
    expect(orderNumber1).toMatch(/^XGX\d+[A-Z0-9]{4}$/);
    expect(orderNumber1).not.toBe(orderNumber2);
  });
});
```

### 2. 集成测试

```typescript
// 测试API端点
import request from 'supertest';
import app from '@/index';

describe('POST /api/v1/auth/login', () => {
  it('should login with valid credentials', async () => {
    const response = await request(app)
      .post('/api/v1/auth/login')
      .send({
        phone: '13800138000',
        password: 'password123',
        role: 'user'
      });
    
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data).toHaveProperty('token');
  });
});
```

### 3. E2E测试

使用Cypress进行端到端测试：

```typescript
// cypress/integration/order-flow.spec.ts
describe('Order Flow', () => {
  it('should create order successfully', () => {
    cy.visit('/login');
    cy.get('[data-testid=phone-input]').type('13800138000');
    cy.get('[data-testid=password-input]').type('password123');
    cy.get('[data-testid=login-button]').click();
    
    cy.url().should('include', '/dashboard');
    
    cy.get('[data-testid=create-order-button]').click();
    cy.get('[data-testid=service-select]').select('手机维修');
    cy.get('[data-testid=device-type-input]').type('iPhone');
    cy.get('[data-testid=description-textarea]').type('屏幕破裂需要更换');
    cy.get('[data-testid=submit-button]').click();
    
    cy.contains('订单创建成功').should('be.visible');
  });
});
```

## 部署指南

### 1. 环境配置

```bash
# 生产环境变量
NODE_ENV=production
PORT=3000
JWT_SECRET=your-super-secret-jwt-key
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
CORS_ORIGIN=https://your-frontend-domain.com
```

### 2. Docker部署

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["npm", "start"]
```

### 3. Nginx配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /var/www/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 4. CI/CD流程

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test
      - run: npm run build
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        run: |
          # 部署脚本
          ssh user@server 'cd /app && git pull && npm install && npm run build && pm2 restart app'
```

## 常见问题

### 1. CORS错误

```typescript
// 解决方案：正确配置CORS
import cors from 'cors';

app.use(cors({
  origin: process.env.CORS_ORIGIN || 'http://localhost:5173',
  credentials: true
}));
```

### 2. JWT过期处理

```typescript
// 前端自动刷新token
axios.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // 尝试刷新token
      try {
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await axios.post('/api/v1/auth/refresh', {
          refreshToken
        });
        
        const { token } = response.data.data;
        localStorage.setItem('token', token);
        
        // 重试原请求
        return axios(error.config);
      } catch (refreshError) {
        // 刷新失败，跳转到登录页
        window.location.href = '/login';
      }
    }
    return Promise.reject(error);
  }
);
```

### 3. 数据库连接问题

```typescript
// 连接池配置
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  {
    db: {
      schema: 'public',
    },
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);
```

## 最佳实践

1. **代码组织**：保持组件小而专注，单一职责原则
2. **错误处理**：统一的错误处理机制，用户友好的错误信息
3. **性能监控**：使用APM工具监控应用性能
4. **日志记录**：结构化日志，便于问题排查
5. **安全审计**：定期进行安全审计和依赖更新
6. **文档维护**：保持文档与代码同步更新

---

本文档将随着项目发展持续更新，如有问题请及时反馈。