# 新干线闪修平台 - 开发文档

## 项目架构

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│   前端应用       │◄──►│   后端API       │◄──►│   Supabase      │
│   (React)       │    │   (Express)     │    │   (数据库)       │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术选型说明

#### 前端技术栈
- **React 18**: 使用最新的React版本，支持并发特性和自动批处理
- **TypeScript**: 提供类型安全，减少运行时错误
- **Ant Design**: 企业级UI组件库，提供丰富的组件和设计规范
- **Zustand**: 轻量级状态管理库，相比Redux更简洁
- **React Router v6**: 最新的路由管理库
- **Tailwind CSS**: 原子化CSS框架，提供灵活的样式控制

#### 后端技术栈
- **Express.js**: 成熟的Node.js Web框架
- **TypeScript**: 后端也使用TypeScript确保类型安全
- **Supabase**: 提供数据库、认证、实时订阅等服务
- **JWT**: 无状态的身份验证方案

## 前端架构详解

### 目录结构

```
src/
├── components/          # 可复用组件
│   ├── ProtectedRoute.tsx
│   └── PublicRoute.tsx
├── pages/              # 页面组件
│   ├── Home.tsx        # 首页
│   ├── Login.tsx       # 登录页
│   ├── CreateOrder.tsx # 创建订单页
│   └── OrderList.tsx   # 订单列表页
├── store/              # 状态管理
│   ├── authStore.ts    # 认证状态
│   └── orderStore.ts   # 订单状态
├── types/              # TypeScript类型定义
│   └── index.ts
├── utils/              # 工具函数
│   └── api.ts          # API请求封装
├── router/             # 路由配置
│   └── index.tsx
├── App.tsx             # 应用根组件
└── main.tsx           # 应用入口
```

### 状态管理

使用Zustand进行状态管理，主要包括：

#### 认证状态 (authStore)
```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
  login: (credentials: LoginRequest) => Promise<void>;
  logout: () => void;
}
```

#### 订单状态 (orderStore)
```typescript
interface OrderState {
  orders: Order[];
  currentOrder: Order | null;
  isLoading: boolean;
  error: string | null;
  fetchOrders: () => Promise<void>;
  createOrder: (order: CreateOrderRequest) => Promise<void>;
  updateOrderStatus: (id: string, status: OrderStatus) => Promise<void>;
}
```

### 路由设计

使用React Router v6进行路由管理：

```typescript
const router = createBrowserRouter([
  {
    path: '/',
    element: <ProtectedRoute><Home /></ProtectedRoute>
  },
  {
    path: '/login',
    element: <PublicRoute><Login /></PublicRoute>
  },
  {
    path: '/order/create',
    element: <ProtectedRoute><CreateOrder /></ProtectedRoute>
  },
  {
    path: '/orders',
    element: <ProtectedRoute><OrderList /></ProtectedRoute>
  }
]);
```

### 组件设计原则

1. **单一职责**: 每个组件只负责一个功能
2. **可复用性**: 提取通用组件，避免重复代码
3. **类型安全**: 所有组件都使用TypeScript定义props类型
4. **响应式设计**: 使用Tailwind CSS实现响应式布局

## 后端架构详解

### 目录结构

```
src/
├── routes/             # API路由
│   ├── auth.ts         # 认证相关路由
│   ├── orders.ts       # 订单相关路由
│   └── services.ts     # 服务相关路由
├── middleware/         # 中间件
│   ├── auth.ts         # 认证中间件
│   └── cors.ts         # CORS中间件
├── utils/              # 工具函数
│   ├── supabase.ts     # Supabase客户端
│   └── jwt.ts          # JWT工具
├── types/              # TypeScript类型定义
│   └── index.ts
└── app.ts              # 应用入口
```

### API设计

#### RESTful API规范

- 使用HTTP动词表示操作类型
- 使用名词表示资源
- 统一的响应格式
- 适当的HTTP状态码

#### 响应格式

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}
```

#### 认证机制

使用JWT进行身份验证：

1. 用户登录后获取JWT token
2. 前端在请求头中携带token
3. 后端中间件验证token有效性
4. 根据用户角色进行权限控制

### 数据库设计

#### 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role user_role NOT NULL DEFAULT 'user',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 订单表 (orders)
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_no VARCHAR(50) UNIQUE NOT NULL,
  user_id UUID REFERENCES users(id),
  service_id UUID REFERENCES services(id),
  service_type VARCHAR(100) NOT NULL,
  device_model VARCHAR(100),
  description TEXT NOT NULL,
  images TEXT[] DEFAULT '{}',
  urgency VARCHAR(20) DEFAULT 'normal',
  status order_status DEFAULT 'pending',
  quoted_price DECIMAL(10,2),
  final_price DECIMAL(10,2),
  estimated_price DECIMAL(10,2),
  assigned_to UUID REFERENCES users(id),
  contact_name VARCHAR(100),
  contact_phone VARCHAR(20),
  address TEXT,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 服务表 (services)
```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  base_price DECIMAL(10,2) NOT NULL,
  options JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 安全考虑

1. **密码加密**: 使用bcrypt对密码进行哈希
2. **JWT安全**: 设置合理的过期时间，使用强密钥
3. **输入验证**: 对所有用户输入进行验证和清理
4. **CORS配置**: 正确配置跨域请求
5. **SQL注入防护**: 使用参数化查询

## 开发流程

### 本地开发环境搭建

1. **克隆项目**
```bash
git clone <repository-url>
cd XGX_Flash_Fix
```

2. **安装依赖**
```bash
# 前端
cd frontend
npm install

# 后端
cd ../backend
npm install
```

3. **配置环境变量**
```bash
# 后端 .env 文件
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
JWT_SECRET=your_jwt_secret
PORT=3001
```

4. **启动开发服务器**
```bash
# 后端 (终端1)
cd backend
npm run dev

# 前端 (终端2)
cd frontend
npm run dev
```

### 代码规范

#### TypeScript规范
- 启用严格模式
- 为所有函数参数和返回值定义类型
- 使用接口定义对象结构
- 避免使用any类型

#### React组件规范
- 使用函数组件和Hooks
- 组件名使用PascalCase
- Props接口以组件名+Props命名
- 使用React.FC类型注解

#### CSS规范
- 优先使用Tailwind CSS类
- 避免内联样式
- 使用语义化的类名
- 保持响应式设计

### 测试策略

#### 前端测试
- 单元测试: 使用Jest和React Testing Library
- 组件测试: 测试组件渲染和交互
- 集成测试: 测试页面级功能

#### 后端测试
- 单元测试: 测试工具函数和中间件
- API测试: 使用Supertest测试API端点
- 数据库测试: 测试数据库操作

### 部署流程

#### 前端部署 (Vercel)
1. 连接GitHub仓库
2. 配置构建命令: `npm run build`
3. 设置环境变量
4. 自动部署

#### 后端部署 (Railway)
1. 连接GitHub仓库
2. 配置启动命令: `npm start`
3. 设置环境变量
4. 配置数据库连接

## 性能优化

### 前端优化
1. **代码分割**: 使用React.lazy进行路由级代码分割
2. **图片优化**: 使用WebP格式，实现懒加载
3. **缓存策略**: 合理使用浏览器缓存
4. **Bundle优化**: 分析和优化打包体积

### 后端优化
1. **数据库优化**: 添加适当的索引
2. **缓存策略**: 使用Redis缓存热点数据
3. **API优化**: 实现分页和字段选择
4. **连接池**: 优化数据库连接管理

## 监控和日志

### 错误监控
- 前端: 使用Sentry进行错误追踪
- 后端: 实现结构化日志记录

### 性能监控
- 前端: 使用Web Vitals监控性能指标
- 后端: 监控API响应时间和错误率

## 常见问题

### Q: 如何添加新的API端点？
A: 在对应的路由文件中添加新的路由处理函数，确保添加适当的认证和验证中间件。

### Q: 如何添加新的页面？
A: 在pages目录创建新组件，在router/index.tsx中添加路由配置。

### Q: 如何处理跨域问题？
A: 在后端配置CORS中间件，允许前端域名的请求。

### Q: 如何调试数据库查询？
A: 在Supabase控制台查看SQL日志，或在代码中添加调试日志。

## 更新日志

### v1.0.1 (2025-01-08) - 问题修复版本
#### 修复的问题
- **订单指派接口错误**: 修正前端orderStore中assignTechnician方法的HTTP请求方式从POST改为PUT，与后端路由定义保持一致
- **订单管理详情按钮无响应**: 在OrderManagement组件中添加useNavigate导入，修复详情按钮点击跳转功能
- **仪表盘数据显示错误**: 修正AdminDashboard组件中字段映射问题：
  - `createdAt` → `created_at`
  - `finalPrice` → `final_price` 
  - `serviceType` → `service_type`
  - `orderNo` → `order_number`
  - `user` → `['users', 'name']`
  - `service_type` → `['services', 'name']`
- **路由跳转路径错误**: 统一订单详情页面路由为`/order/detail/:id`

#### 技术改进
- 完善了前后端数据字段映射的一致性
- 优化了组件间的路由跳转逻辑
- 提升了用户界面的交互体验

### v1.0.0 (2025-01-08) - 初始版本
- 项目初始化和基础架构搭建
- 实现用户认证系统（注册、登录、JWT认证）
- 实现订单管理功能（创建、查看、状态更新）
- 实现管理后台（用户管理、订单管理、数据统计）
- 实现技师工作台（订单分配、状态更新）
- 集成Supabase数据库和认证服务
- 完成基于Ant Design的响应式UI设计
- 建立前后端API通信机制